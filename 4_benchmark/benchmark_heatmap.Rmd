---
title: "Feature Selection Genes of Kidney Cancer with mRMRe (TCGA-KIRC)"
output:
# pdf_document: default
  html_document: 
    default
  github_document: 
    df_print: paged
    html_preview: FALSE
    keep_html: TRUE
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_format = "all") })      
---

  
```{r error=TRUE, message=FALSE, warning=FALSE, include=FALSE, purl=FALSE, results='hide'}
## This chunk automatically generates a text .R version of this script when running within knitr.
input  = knitr::current_input()  # filename of input document
output = paste(tools::file_path_sans_ext(input), 'R', sep = '.')
try(knitr::purl(input,output,documentation=2,quiet=T), silent = TRUE)
# Avoid duplicate label error of knitr::purl
options(knitr.duplicate.label = 'allow')
# Code to browse the markdown file with renderized images.
knitr::opts_chunk$set(
  fig.path = "figs/render-"
)
```


# Installing and Loading Libraries            


```{r message=FALSE, warning=FALSE, paged.print=FALSE}

#library(annotables) # BiocManager::install("annotate")
# 
# packages_bioconductor = c("clusterProfiler", "org.Hs.eg.db", "ReactomePA", "DOSE")
# 
# #use this function to check if each package is on the local machine
# #if a package is installed, it will be loaded
# #if any are not, the missing package(s) will be installed from Bioconductor and loaded
# package.check <- lapply(packages_bioconductor, FUN = function(x) {
#   if (!require(x, character.only = TRUE)) {
#     BiocManager::install(x, dependencies = TRUE)
#     library(x, character.only = TRUE)
#   }
# })

packages_cran = c("tidyverse", "GOplot")
  
#use this function to check if each package is on the local machine
#if a package is installed, it will be loaded
#if any are not, the missing package(s) will be installed from CRAN and loaded
package.check <- lapply(packages_cran, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE)
    library(x, character.only = TRUE)
  }
})

if(!require('grid')){install.packages('grid')} # 
if(!require('gridExtra')) {install.packages('gridExtra')} #  Provides a number of user-level functions to work with "grid" graphics
if(!require('cowplot')) {install.packages('cowplot')} # provides various features that help with creating publication-quality figures
if(!require('GOplot')) {install.packages('GOplot')} #
if(!require('glmnet')) {install.packages('glmnet')} #
if(!require('survC1')) {install.packages('survC1')} #
if(!require('survAUC')) {install.packages('survAUC')}
if(!require('survival')) {install.packages('survival')} 
if(!require('survminer')) {install.packages('survminer')} 
if(!require('survivalROC')) {install.packages('survivalROC')} 
if(!require('ggpmisc')) {install.packages('ggpmisc')} 
if(!require('glmpca')) {install.packages('glmpca')} 
if(!require('glmnet')) {install.packages('glmnet')} 
if(!require('factoextra')) {install.packages('factoextra')}
if(!require('FactoMineR')) {install.packages('FactoMineR')} 

rm(packages_cran, package.check)

```

# Load Data

```{r}
load(file = "../data/2.gsign_kidney.rda")
load(file = "../data/surv/3.data.benchmark_tcgadata_3cv_no_colinear.rda") # job_benchmark_grid.R 3.data.benchmark_tcgadata_3cv.rda

gsign_kidney <- gsign_kidney %>%
  dplyr::filter(!id %in% c("sign.3", "sign.4",  "sign.11", "sign.13", "sign.14", "fs.genetic", "fs.mRMR.status", "fs.mRMR.time")) %>%
  mutate(id =  fct_recode(id,
    Ha.2015.CaInfo = "sign.1",
    Zhan.2015.CMMM = "sign.2",
    Dai.2016.Oncotarget = "sign.5",
    Wan.2017.IJCancer = "sign.6",
    Chang.2018.Medicine = "sign.7",
    YuanLeiChen.2018.JCP = "sign.8",
    Hu.2019.IJMS = "sign.9",
    LiangChen.2018.JCP = "sign.10",
    #Pan.2019.MSM.5genes = "sign.11", # removed
    Pan.2019.MSM = "sign.12",
    Wu.2019.FrontiersOnco = "sign.15",
    Jiang.2020.ACS = "sign.16",
    Zou.2020.PeerJ = "sign.17",
    LingChen.2020.Hereditas = "sign.18",
    DCosta.2020.SciReports = "sign.19",
    GBM = "filt.gbm",
    Rpart = "filt.rpart",
    XGBoost = "filt.xgboost",
    Boruta = "fs.boruta",
    RFE = "fs.mlr.rfe",
    mRMR = "fs.mRMR"
    ))



bmr.measure <- bmr_table_pp %>% 
  dplyr::filter(!task_id %in% c("sign.3", "sign.4",  "sign.11", "sign.13", "sign.14", "fs.genetic", "fs.mRMR.status", "fs.mRMR.time")) %>%
  dplyr::filter(pp %in% "BoxCox") %>%
  dplyr::select(-c("pp")) %>%
  dplyr::mutate(task_id =  fct_recode(task_id,
                                      Ha.2015.CancerInfo = "sign.1",
                                      Zhan.2015.CMMM = "sign.2",
                                      Dai.2016.Oncotarget = "sign.5",
                                      Wan.2017.IJCancer = "sign.6",
                                      Chang.2018.Medicine = "sign.7",
                                      YuanLeiChen.2018.JCP = "sign.8",
                                      Hu.2019.IJMS = "sign.9",
                                      LiangChen.2018.JCP = "sign.10",
                                      #Pan.2019.MSM.5genes = "sign.11",
                                      Pan.2019.MSM = "sign.12",
                                      Wu.2019.FrontiersOnco = "sign.15",
                                      Jiang.2020.ACS = "sign.16",
                                      Zou.2020.PeerJ = "sign.17",
                                      LingChen.2020.Hereditas = "sign.18",
                                      DCosta.2020.SciReports = "sign.19",
                                      GBM = "filt.gbm",
                                      Rpart = "filt.rpart",
                                      XGBoost = "filt.xgboost",
                                      Boruta = "fs.boruta",
                                      RFE = "fs.mlr.rfe",
                                      mRMR = "fs.mRMR"))

rownames(gsign_kidney) <- gsign_kidney$id

gsign_kidney["mRMR", "signature"][[1]] <- list(c("AL353637.1", "AR",  "DPP6", "FOXJ1", "FOXJ1", "GNB3", "HHLA2", "IL4", "LIMCH1", "LINC01732", "OTX1", "SAA1", "SEMA3G", "ZIC2"))
 

# gsign_kidney0 <- gsign_kidney
# gsign_kidney0$signature <- gsub(')', '', gsub('c(', '', fixed = TRUE, gsub("\"", "", paste(gsign_kidney0$signature),",")))
# write.table(gsign_kidney0[,c("id", "signature")], file = "../data/gsign_kidney.tsv", col.names = T, row.names = F, sep = "\t", quote = T)

```

# Heatmap of Signatures metrics for 3cv with 10 repeats

## Arrange signatures means in increasing order

```{r}

task_id_order <- bmr.measure %>% 
  group_by(task_id) %>% 
  summarise(surv.uno_auc = mean(surv.uno_auc)) %>% 
  arrange(surv.uno_auc)

task_id_order$learner_id <- "mean_signature"
task_id_order$resampling_id <- NA
task_id_order$iters <- NA
task_id_order$surv.harrell_c <- NA

bmr.measure <- rbind(bmr.measure, task_id_order)

bmr.measure$task_id <- factor(bmr.measure$task_id, levels = c("mean_models", as.character(task_id_order$task_id)))

```


## Arrange learners medians in increasing order

```{r}
learner_id_order <- bmr.measure %>% 
  group_by(learner_id) %>% 
  summarise(surv.uno_auc = mean(surv.uno_auc)) %>% 
  arrange(surv.uno_auc)

learner_id_order$task_id <- "mean_models"
learner_id_order$resampling_id <- NA
learner_id_order$iters <- NA
learner_id_order$surv.harrell_c <- NA


bmr.measure <- rbind(bmr.measure, learner_id_order)

bmr.measure$learner_id <- factor(bmr.measure$learner_id, levels = c("mean_signature", setdiff(unique(learner_id_order$learner_id), "mean_signature")))

```

# Plot Heatmap Cross-validation with 100 repetitions 

```{r}

p1 <- ggplot(bmr.measure, aes(learner_id, task_id)) +
  geom_tile(aes(fill = surv.uno_auc)) + 
  geom_text(aes(label = round(surv.uno_auc, 2)), colour = "white") +
  scale_fill_gradient(low = "lightblue", high = "darkblue") +
  ggtitle("Mean AUC on TCGA-KIRC dataset with 3 CV and 100 repeats")+
  ylab("Gene Signatures & Feature Selection Methods") +
  xlab("Models") +
  theme(axis.text.x = element_text(angle = 45, hjust=1), legend.position="none") +
  scale_x_discrete(expand=c(0,0)) #+ 
 # ggsave("../plots/fig4_heatmap_3cv.pdf", width = 14, height = 9, units = c("in"))
  

rm(list = setdiff(ls(), c("p1","gsign_kidney")))
```




## Arrange learners means in increasing order

```{r}
load(file = "../data/surv/3.data.benchmark_train.tcga.test.icgc.rda") # job_benchmark_grid.R 3.data.benchmark_train.tcga.test.icgc.rda

bmr.measure <- bmr_table_pp %>% 
  dplyr::filter(!task_id %in% c("filt.gbm", "filt.rpart", "filt.xgboost", "fs.boruta", "fs.mlr.rfe", "fs.mRMR"))

load(file = "../data/surv/3.data.benchmark_train.tcga.test.icgc_no_colinear.rda") # job_benchmark_grid.R 3.data.benchmark_train.tcga.test.icgc.rda

bmr_table_pp <- rbind(bmr_table_pp,bmr.measure)

bmr.measure <- bmr_table_pp %>% 
  dplyr::filter(!task_id %in% c("sign.3", "sign.4",  "sign.11", "sign.13", "sign.14", "fs.genetic", "fs.mRMR.status", "fs.mRMR.time")) %>%
  dplyr::select(-c("pp")) %>%
  dplyr::mutate(task_id =  fct_recode(task_id,
                                      Ha.2015.CancerInfo = "sign.1",
                                      Zhan.2015.CMMM = "sign.2",
                                      Dai.2016.Oncotarget = "sign.5",
                                      Wan.2017.IJCancer = "sign.6",
                                      Chang.2018.Medicine = "sign.7",
                                      YuanLeiChen.2018.JCP = "sign.8",
                                      Hu.2019.IJMS = "sign.9",
                                      LiangChen.2018.JCP = "sign.10",
                                      #Pan.2019.MSM.5genes = "sign.11",
                                      Pan.2019.MSM = "sign.12",
                                      Wu.2019.FrontiersOnco = "sign.15",
                                      Jiang.2020.ACS = "sign.16",
                                      Zou.2020.PeerJ = "sign.17",
                                      LingChen.2020.Hereditas = "sign.18",
                                      DCosta.2020.SciReports = "sign.19",
                                      GBM = "filt.gbm",
                                      Rpart = "filt.rpart",
                                      XGBoost = "filt.xgboost",
                                      Boruta = "fs.boruta",
                                      RFE = "fs.mlr.rfe",
                                      mRMR = "fs.mRMR"))

task_id_order <- bmr.measure %>% 
  group_by(task_id) %>% 
  summarise(surv.uno_auc = mean(surv.uno_auc)) %>% 
  arrange(surv.uno_auc)

task_id_order$learner_id <- "mean_signature"
task_id_order$resampling_id <- NA
task_id_order$iters <- NA
task_id_order$surv.harrell_c <- NA

bmr.measure <- rbind(bmr.measure, task_id_order)

levs <-  c("mean_models", setdiff(as.character(task_id_order$task_id), c("mRMR", "GBM")), c("mRMR", "GBM"))

bmr.measure$task_id <- factor(bmr.measure$task_id, levels = levs )

learner_id_order <- bmr.measure %>% 
  group_by(learner_id) %>% 
  summarise(surv.uno_auc = mean(surv.uno_auc)) %>% 
  arrange(surv.uno_auc)

learner_id_order$task_id <- "mean_models"
learner_id_order$resampling_id <- NA
learner_id_order$iters <- NA
learner_id_order$surv.harrell_c <- NA


bmr.measure <- rbind(bmr.measure, learner_id_order)

bmr.measure$learner_id <- factor(bmr.measure$learner_id, levels = c("mean_signature", setdiff(unique(learner_id_order$learner_id), "mean_signature")))

```



# Plot Heatmap Cross-validation with 100 repetitions 

```{r}

p2 <- ggplot(bmr.measure, aes(learner_id, task_id)) +
  geom_tile(aes(fill = surv.uno_auc)) + 
  geom_text(aes(label = round(surv.uno_auc, 2)), colour = "white") +
  scale_fill_gradient(low = "lightblue", high = "darkblue") +
  ggtitle("Mean AUC on training TCGA-KIRC and testing ICGC-RECA")+
  ylab("Gene Signatures & Feature Selection Methods") +
  xlab("Models") +
  theme(axis.text.x = element_text(angle = 45, hjust=1), legend.position="none")
  scale_x_discrete(expand=c(0,0)) #+ 
  #ggsave("../plots/fig4_heatmap_trn.tcga.tst.icgc.pdf", width = 14, height = 9, units = c("in"))
  
rm(learner_id_order, task_id_order)

```




# Box plot only with significants genes

```{r}
#load("bmk_tcga_3cv_10repeats_nofilter.rda") # KIRC_2_benchmark_boxplot_tcga3v_job.R 
load("bmk_tcga_3cv_10repeats_no_collinear_significance.rda")
#load("bmk_tcga_3cv_10repeats_no_collinear.rda") # KIRC_2_benchmark_boxplot_tcga3v_job.R


bmk_tcga <- bmk_tcga %>% 
  dplyr::mutate(sign =  fct_recode(sign,
                                      Ha.2015.CancerInfo = "Ha.2014.CancerInfo",
                                      GBM = "filt.gbm",
                                      Rpart = "filt.rpart",
                                      XGBoost = "filt.xgboost",
                                      Boruta = "wrap.boruta",
                                      RFE = "wrap.rfe",
                                      mRMR = "wrap.mRMR"))

bmk_tcga_auc <- bmk_tcga %>% 
  group_by(sign) %>%
  summarise(auc=mean(auc_uno)) %>% 
  arrange(auc) %>%
  as.data.frame(.)

bmk_tcga$sign <- factor(bmk_tcga$sign, levels = c(as.character(bmk_tcga_auc$sign)))

dtF <- rbind(
  data.frame(sign=bmk_tcga$sign, num=log10(bmk_tcga$p.val), cut=0.05, what="p-value of survival risk"),
  data.frame(sign=bmk_tcga$sign, num=bmk_tcga$auc_uno, cut=0.65, what="auc on 10 years"))

dtF$color <- ifelse(dtF$sign %in% bmk_tcga_auc$sign[bmk_tcga_auc$p < 0.05],"#FF1F5B", "gray80")

g1 <- ggplot() +
  geom_boxplot(data=dtF[dtF$what=="p-value of survival risk",], mapping = aes(x = sign, y = num, colour=color), 
               outlier.size=0.2, width=0.2) +
  geom_hline(data=dtF[dtF$what=="p-value of survival risk",], yintercept=log10(0.05), 
               linetype="dashed", color = "red") +
  annotate("text", bmk_tcga_auc$sign[4], log10(0.05), vjust = -0.5, label = "mean of p-value < 0.05", color = "red") +
  scale_x_discrete(NULL, labels = NULL)+
  ggtitle("TCGA-KIRC with CV 3 folds in 100 repeats")+
  theme(plot.title=element_text(), axis.text.x = element_text(),
        axis.ticks.x.bottom = element_line(color = "white"),
        legend.position="none") +
  facet_wrap(~what, strip.position = "right") +
  coord_cartesian(ylim=c(-16,0)) +
  scale_color_manual(values=c("#FF1F5B", "gray60")) +
  xlab("") +
  ylab("log10(p-value)")

g2 <-ggplot() +
  geom_boxplot(data=dtF[dtF$what=="auc on 10 years",], mapping = aes(x = sign, y = num), 
              color = "#009ADE", outlier.size=0.2, width=0.2) +
  geom_text(data=bmk_tcga_auc,
    aes(y=auc, x = sign, label=round(auc,2)), angle=45, vjust = -1.4, size=3,
    color='#0D4A70', position=position_dodge(1)
  ) +
  theme(plot.title=element_text(hjust=0.5, size=12), 
        axis.text.x = element_text(angle = 45, hjust=1),
        axis.title.y = element_text(margin = margin(t = 0, r = 13, b = 0, l = 0))) +
  facet_wrap(~what, strip.position = "right") +
  #scale_y_continuous(breaks=seq(0.4,0.7,0.05)) +
  #coord_cartesian(ylim=c(0.4,0.7))+
  xlab("Gene Signature & Feature Selection Methods") +
  ylab("auc_uno")
#pdf("../plots/KIRC_2_benchmark_fig1_boxplot_tcga.cv3.pdf", width = 10, height = 6)
gE1 <- gridExtra::grid.arrange(g1, g2, ncol=1, heights=c(0.5, 1))
#dev.off()

```


# Train TCGA Test ICGC - 100 repeats

## Arrange signatures medians in increasing order


```{r}
# KIRC_2_benchmark_boxplot_job.R 
load("~/gene_signature/4_gene_selection/validation_tcga_icgc_2555.mrmr.rda")

#load("bmk_icgc_nofilter_2555_100repeats_no_collinear_significance.rda") # 
#load("bmk_icgc_nofilter_2555_100repeats_no_collinear.rda") # top fs.mRMR and rfe no significative
#load("bmk_icgc1.rda") # top fs.mRMR and rfe no significative
#load("bmk_icgc_nofilter_3650_100repeats.rda") # 

bmk_icgc <- bmk_icgc %>% 
  dplyr::filter(!sign %in% c("sign.3", "sign.4",  "sign.11", "sign.13", "sign.14", "wrap.mRMR")) %>%
  dplyr::mutate(sign =  fct_recode(sign,
                                      Ha.2015.CancerInfo = "Ha.2014.CaInfo",
                                      GBM = "filt.gbm",
                                      Rpart = "filt.rpart",
                                      XGBoost = "filt.xgboost",
                                      Boruta = "wrap.boruta",
                                      RFE = "wrap.rfe",
                                      #mRMR = "wrap.mRMR",
                                      mRMR = "mRMR.search"))

bmk_icgc_auc <- bmk_icgc %>% 
  group_by(sign) %>%
  summarise(auc=median(auc_uno)) %>% 
  arrange(auc) %>%
  as.data.frame(.)

bmk_icgc_pval <- bmk_icgc %>% 
  group_by(sign) %>%
  summarise(p=median(padj)) %>% 
  arrange(desc(p)) %>%
  as.data.frame(.)

bmk_icgc$sign <- factor(bmk_icgc$sign, levels = union(setdiff(as.character(bmk_icgc_auc$sign),"mRMR"), "mRMR"))

dtF <- rbind(
  data.frame(sign=bmk_icgc$sign, num=bmk_icgc$padj, cut=0.05, what="p-adj of survival risk"),
  data.frame(sign=bmk_icgc$sign, num=bmk_icgc$auc_uno, cut=0.65, what="auc on 7 years"))

dtF$color <- ifelse(dtF$sign %in% bmk_icgc_pval$sign[bmk_icgc_pval$p < 0.05], "blue", "gray80") # #FF1F5B

g1 <- ggplot() +
  geom_boxplot(data=dtF[dtF$what=="p-adj of survival risk",], mapping = aes(x = sign, y = num, colour=color), 
               outlier.size=0.2, width=0.2) +
   geom_text(data=bmk_icgc_pval,
    aes(y=p, x = sign, label=ifelse(p<0.05, round(p,3), round(p,2) )),  
    vjust = -1.3, hjust = 0.2, angle=45, size=3,
    color='#0D4A70', position=position_dodge(1)
  ) +
  geom_hline(yintercept=0.05, linetype="dashed", color = "blue") +
  annotate("text", bmk_icgc_auc$sign[4],  0.1, vjust = -0.5, label = "p-adjusted < 0.05", color = "blue") +
  scale_x_discrete(NULL, labels = NULL)+
  ggtitle("Training TCGA-KIRC and Testing ICGC-RECA in 100 repeats")+
  theme(plot.title=element_text(), axis.text.x = element_text(),
        axis.ticks.x.bottom = element_line(color = "white"),
        legend.position="none") +
  facet_wrap(~what, strip.position = "right") +
  scale_y_continuous(breaks=seq(0,1,0.5)) +
  coord_cartesian(ylim=c(0.05,1.1)) +
  scale_color_manual(values=c("#FF1F5B", "gray60")) +
  xlab("") +
  ylab("p-adjusted value")

g2 <-ggplot() +
  geom_boxplot(data=dtF[dtF$what=="auc on 7 years",], mapping = aes(x = sign, y = num), 
              color = "#009ADE", outlier.size=0.2, width=0.2) +
  geom_text(data=bmk_icgc_auc,
    aes(y=auc, x = sign ,label=round(auc,2)),  vjust = -1, angle=45, size=3,
    color='#0D4A70', position=position_dodge(1)
  ) +
  theme(plot.title=element_text(hjust=0.5, size=12), 
        axis.text.x = element_text(angle = 45, hjust=1)) +
  facet_wrap(~what, strip.position = "right") +
  scale_y_continuous(breaks=seq(0.4,0.8,0.05)) +
  coord_cartesian(ylim=c(0.4,0.8))+
  xlab("Survival Predition of Gene Signatures & Feature Selection Methods") +
  ylab("AUC-Uno")
pdf("../plots/KIRC_2_benchmark_fig1_boxplot_trn.tcga.tst.icgc.pdf", width = 10, height = 6)
gE2 <- gridExtra::grid.arrange(g1, g2, ncol=1, heights=c(0.5, 1))
dev.off()

```


```{r}
pdf("../plots/fig_4_a_b_heatmap_boxplots.pdf", width = 9, height = 12)
  cowplot::plot_grid(p1, gE2, labels = c("a","b"), nrow=2)
dev.off()
```

```{r}
pdf("../plots/fig_supl_heatmap_ICGC.pdf", width = 8, height = 6)
  cowplot::plot_grid(p2, labels = "", nrow=1)
dev.off()

pdf("../plots/fig_supl_boxplots_TCGA.pdf", width = 8, height = 6)
  cowplot::plot_grid(gE1, labels = "", nrow=1)
dev.off()

```



# Venn diagrams of signatures

```{r}

genes_DEA_M0 <- readLines("../2_gene_expression_differentiation/genes.DEA.M0.vs.M1.lst")
genes_DEA_NT <- readLines("../2_gene_expression_differentiation/genes.DEA.NT.vs.TP.lst")
# genes_risk <- readLines("../3_gene_mutational_survival/genes_mutated.highrisk.lst")
genes_eqtls <- readLines("../data/genes_kidney_cortex_eqtls.lst")
genes_papers <- unique(unlist(gsign_kidney$signature[c(1:14)])) # readLines("../data/genes_papers.lst")

genes_DEA_M0 <- gsub("-", ".", genes_DEA_M0)
genes_DEA_NT <- gsub("-", ".", genes_DEA_NT)
genes_eqtls <- gsub("-", ".", genes_eqtls)
genes_papers <- gsub("-", ".", genes_papers)

#genes_mRMR <- setdiff(unlist(gsign_kidney["mRMR", "signature"]) , "age" )
genes_mRMR <- c("AL353637.1", "AR",  "DPP6", "FOXJ1", "FOXJ1", "GNB3", "HHLA2", "IL4", "LIMCH1", "LINC01732", "OTX1", "SAA1", "SEMA3G", "ZIC2")
genes_mRMR <- gsub("-", ".", genes_mRMR)

genes_selection <-  unique(union(union(union(genes_DEA_M0, genes_DEA_NT), genes_papers), genes_eqtls))

named.list.for.venn <-
   list(genes_mRMR = genes_mRMR, 
        `DEA_NT` = genes_DEA_NT,
        genes_eqtls = genes_eqtls,
        genes_papers = genes_papers,
        `DEA_M0` = genes_DEA_M0)

library(VennDiagram)

futile.logger::flog.threshold(futile.logger::ERROR, name = "VennDiagramLogger")
pvenn <-
  venn.diagram(
    x = named.list.for.venn,
    #filename = "../plots/fig2a_venn.png",
    filename = NULL,
    category.names = c("Genes mRMR", "DEA NT vs TP" , "Genes Kidney eQTLS", "Genes of Selected Papers", "DEA M0 vs M1" ),
    imagetype = "png",
    #col = "transparent",,
    # Circles
    lwd = 2,
    lty = 'blank',
    fill = c("#ed85b0", "#E69F00", "#56B4E9", "#009E73", "#999999"), #
  #alpha = 0.50,
   # label.col = c("orange", "white", "orange", "white", "darkblue", "white", "darkgreen", "white"),
    cex = 1,
    fontfamily = "sans",
    #fontface = "bold",
    #cat.col = c("darkblue", "darkgreen", "orange"),
    cat.fontfamily = "sans",
    cat.cex = .75,
    #cat.fontface = "bold",
    cat.default.pos = "outer",
    cat.just =  list( c(0.5, 1), c(0, 1), c(0.1, 0.1),  c(0.5, 1), c(1, 0)) 
    #cat.dist = c(0.1, 0.5, 0.1, 0.1, c(0.001,)
    )

rm(list = setdiff(ls(), c("pvenn", "gsign_kidney")))
```


# Load data DEA


```{r}
load("../data/1.data.processed.rda")

genes_DEA_M0 <- readLines("../2_gene_expression_differentiation/genes.DEA.M0.vs.M1.lst")
genes_DEA_NT <- readLines("../2_gene_expression_differentiation/genes.DEA.NT.vs.TP.lst")
#genes_risk <- readLines("../3_gene_mutational_survival/genes_mutated.highrisk.lst")
genes_eqtls <- readLines("../data/genes_kidney_cortex_eqtls.lst")
#genes_papers <- readLines("../data/genes_papers.lst")
#genes_mRMR <- setdiff(unlist(gsign_kidney["mRMR", "signature"]) , "age" )
genes_mRMR <- c("AL353637.1", "AR",  "DPP6", "FOXJ1", "FOXJ1", "GNB3", "HHLA2", "IL4", "LIMCH1", "LINC01732", "OTX1", "SAA1", "SEMA3G", "ZIC2")

genes_papers <- unique(unlist(gsign_kidney$signature[c(1:14)])) #readLines("../data/genes_papers.lst")

load("../data/dea.M0.M1.rda")
load("../data/dea.NT.TP.rda")

genes_all <- union(union(union(union(genes_DEA_M0, genes_DEA_NT), genes_eqtls), genes_papers), genes_mRMR)

#genes_all <- setdiff(genes_all, colnames(data))

```


```{r message=FALSE, warning=FALSE, include=FALSE}
library(ggrepel)
#knitr::include_graphics("../plots/KIRC_2_benchmark_fig3_venn.png", dpi = NA)

# df.deseq <- dea.NT.TP  %>% filter(abs(logFC) >= 3, pvalue <= 0.05)
mydata <- dea.NT.TP %>% 
  dplyr::filter(dea.NT.TP$symbol %in% genes_all) 

#cutoff <- sort(mydata$pvalue[mydata$symbol %in% unique(unlist(gsign_kidney$signature))])[30]
#cutoff <- sort(mydata$pvalue[mydata$symbol %in% genes_mRMR])[30]

mydata <- mydata %>% 
    #mutate(gene_label=ifelse(symbol %in% unique(unlist(gsign_kidney$signature)), symbol, "")) %>% # For all genes on signatures
    mutate(gene_label=ifelse(symbol %in% genes_mRMR, symbol, "")) %>%    # For only genes on mRMR
    #mutate(gene_label=ifelse(pvalue < cutoff, gene_label, "")) %>% 
    mutate(sig=ifelse((logFC >= 3 & pvalue < 0.05), "up", ifelse((logFC <= -3 & pvalue < 0.05), "down", "notsig")))

colours <- setNames(c("cornflowerblue", "grey", "firebrick"), c("down", "notsig", "up"))

p1 <- ggplot(mydata, aes(x = logFC, y = -log10(FDR), col=sig)) +
  geom_point(alpha = 0.5)  +
  scale_color_manual(values=colours) +
  geom_vline(xintercept=c(-3,3), linetype="dotted") +
  geom_hline(yintercept=c(-log10(0.01)), linetype="dotted") +
  ggtitle("DEA of Normal vs Tumor samples") +
  xlab("Gene expression change\n log2(FC)") +
  ylab("Significance\n -log10(FDR)") +
  xlim(c(-50,50)) +
  ylim(c(-2,550)) +
  theme(plot.margin = unit(c(0, 0, 0, 0), "cm"), legend.position="none") +
  geom_label_repel(data = mydata[mydata$logFC > -3 & mydata$logFC < 3 , ],
           aes(label=gene_label),
           seed = 123,
           xlim = c(NA, 25),  # reduce overlaps
           ylim = c(430, NA),
           direction = "both",
           max.time = 5,
           max.iter = 1e5,
           force = 1,
           size = 3,
           max.overlaps = Inf) +
  geom_label_repel(data = mydata[mydata$logFC > 3, ],
            aes(label=gene_label),
            seed = 123,
            xlim = c(30, NA),  # reduce overlaps
            ylim = c(-1,500),
            direction = "y",
            max.time = 5,
            max.iter = 1e5,
            force = 2,
            size = 3,
            max.overlaps = Inf) +
  geom_label_repel(data = mydata[mydata$logFC < -3, ],
            aes(label=gene_label),
            seed = 123,
            xlim = c(NA, -30),  # reduce overlaps
            ylim = c(0, 450),
            #nudge_x = -30  - subset(mydata, logFC < -3)$logFC,
            hjust = 1,
            direction = "y",
            max.time = 5,
            max.iter = 1e5,
            force = 1,
            size = 3,
            max.overlaps = Inf)


#df.deseq <- dea.M0.M1  %>% filter(abs(logFC) >= 2, pvalue <= 0.05)
mydata <- dea.M0.M1 %>% 
  dplyr::filter(symbol %in% genes_all) 

#cutoff <- sort(mydata$pvalue[mydata$symbol %in% unique(unlist(gsign_kidney$signature))])[30]
#cutoff <- sort(mydata$pvalue[mydata$symbol %in% genes_mRMR])[30]

mydata <- mydata %>% 
    #mutate(gene_label=ifelse(symbol %in% unique(unlist(gsign_kidney$signature)), symbol, "")) %>% # For all genes on signatures
    mutate(gene_label=ifelse(symbol %in% genes_mRMR, symbol, "")) %>%    # For only genes on mRMR
    #mutate(gene_label=ifelse(pvalue < cutoff, gene_label, "")) %>% 
    mutate(sig=ifelse((logFC >= 2 & pvalue < 0.05), "up", ifelse((logFC <= -2 & pvalue < 0.05), "down", "notsig")))

p2 <- ggplot(mydata, aes(x = logFC, y = -log10(FDR), col=sig)) +
  geom_point(alpha = 0.5)  +
  scale_color_manual(values=colours) +
        geom_vline(xintercept=c(-2,2), linetype="dotted") +
        geom_hline(yintercept=c(-log10(0.05)), linetype="dotted") +
        ggtitle("DEA of Non-metastatic vs Metastatic samples") +
        xlab("Gene expression change\n log2(FC)") +
        ylab("Significance\n -log10(FDR)") +
        xlim(-15,15) +
        ylim(-1,70) +
        theme(plot.margin = unit(c(0, 0, 0, 0), "cm"), legend.position="none") +
        geom_label_repel(data = mydata[mydata$logFC < -2, ],
                         aes(label=gene_label),
                         seed = 123,
                         xlim = c(NA, -7.5),  # reduce overlaps
                         ylim = c(0, 60),
                         nudge_x = -7.5  - subset(mydata, logFC < -2)$logFC,
                         hjust = 1,
                         direction = "y",
                         max.time = 5,
                         max.iter = 1e5,
                         force = 0.2,
                         size = 3,
                         max.overlaps = Inf) +
        geom_label_repel(data = mydata[mydata$logFC > 2, ],
                         aes(label=gene_label),
                         seed = 123,
                         xlim = c(7.5, NA),  # reduce overlaps
                         ylim = c(-1, 70),
                         nudge_x = 7.5  - subset(mydata, logFC > 2)$logFC,
                         direction    = "y",
                         hjust = 0,
                         max.time = 5,
                         max.iter = 1e5,
                         force = 1,
                         size = 3,
                         max.overlaps = Inf) +
          geom_label_repel(data = mydata[mydata$logFC > -2 & mydata$logFC < 2 , ],
                         aes(label=gene_label),
                         seed = 123,
                         xlim = c(NA, NA),  # reduce overlaps
                         ylim = c(40, NA),
                         direction = "both",
                         max.time = 5,
                         max.iter = 1e5,
                         force = 20,
                         size = 3,
                         max.overlaps = Inf)
        
  
  
pdf("../plots/fig_2_a_c_venn_volcanos.pdf", width = 5, height = 16)
  cowplot::plot_grid(grobTree(pvenn), NULL, p1, NULL,  p2, 
                     label_size = 20,
                     labels = c("a", "", "b", "", "c"), 
                     nrow=5, rel_heights = c(1, 0.1, 1, 0.1, 1))
dev.off()

#rm(colours, p1, p2, pvenn, mydata, cutoff)
```


# UpSet Plot 

```{r}

#install.packages("UpSetR")
library(UpSetR)
library(ggrepel)

cols <- c("gene", "genes_DEA_M0", "genes_DEA_NT", "genes_eqtls", "genes_papers",  as.character(gsign_kidney$id))
genes_upset <- as.data.frame(matrix(nrow = length(genes_all), ncol = length(cols)))
colnames(genes_upset) <- cols
genes_upset$gene <- genes_all
rownames(gsign_kidney) <- gsign_kidney$id
  
for(sign_id in gsign_kidney$id) {
  genes_upset[,sign_id]  <- as.numeric(genes_upset$gene %in% gsign_kidney[sign_id, "signature"][[1]])
}

gene_list <- list(genes_DEA_NT, genes_DEA_M0,  genes_eqtls, genes_papers) # genes_risk,
names(gene_list) <- c("genes_DEA_NT", "genes_DEA_M0", "genes_eqtls", "genes_papers") # "genes_risk", 

for(l in names(gene_list)) {
  genes_upset[, l] <- as.numeric(genes_upset$gene %in% gene_list[[l]]) 
}

rownames(dea.M0.M1) <- dea.M0.M1$symbol
rownames(dea.NT.TP) <- dea.NT.TP$symbol

genes_upset$logFC.M0.M1 <-  dea.M0.M1[genes_upset$gene,"logFC"]
genes_upset$logFC.NT.TP <-  dea.NT.TP[genes_upset$gene,"logFC"]

genes_upset$logFC.M0.M1[is.na(genes_upset$logFC.M0.M1)] <- 0
genes_upset$logFC.NT.TP[is.na(genes_upset$logFC.NT.TP)] <- 0

genes_upset$nlog10FDR.M0.M1 <- -log10(dea.M0.M1[genes_upset$gene,"FDR"])
genes_upset$nlog10FDR.NT.TP <- -log10(dea.NT.TP[genes_upset$gene,"FDR"])

genes_upset$nlog10FDR.NT.TP[is.na(genes_upset$nlog10FDR.NT.TP)] <- 0
genes_upset$nlog10FDR.M0.M1[is.na(genes_upset$nlog10FDR.M0.M1)] <- 0

# sets_list <- c("Ha.2014.CaInfo", "Zhan.2015.CMMM", "Dai.2016.Oncotarget", "Wan.2017.IJCancer", "Chang.2018.Medicine", "YuanLeiChen.2018.JCP",
#           "Hu.2019.IJMS", "LiangChen.2018.JCP", "Pan.2019.MSM", "Wu.2019.FrontiersOnco", "Jiang.2020.ACS", 
#           "Zou.2020.PeerJ", "LingChen.2020.Hereditas", "DCosta.2020.SciReports", "filt.gbm", "Rpart", "XGBoost", "Boruta",
#           "RFE", "mRMR", "genes_DEA_M0", "genes_DEA_NT", "genes_eqtls") 

mRMR <- gsign_kidney["mRMR","signature"][[1]]
Boruta <- gsign_kidney["Boruta","signature"][[1]]
RFE <- gsign_kidney["RFE","signature"][[1]]
GBM <- gsign_kidney["GBM","signature"][[1]]
Rpart <- gsign_kidney["Rpart","signature"][[1]]
XGBoost <- gsign_kidney["XGBoost","signature"][[1]]

```


# Chord data

```{r}
Pan.2019.MSM <- gsign_kidney["Pan.2019.MSM","signature"][[1]]
Jiang.2020.ACS <- gsign_kidney["Jiang.2020.ACS","signature"][[1]]
Chang.2018.Medicine  <- gsign_kidney["Chang.2018.Medicine","signature"][[1]]
Zou.2020.PeerJ   <- gsign_kidney["Zou.2020.PeerJ","signature"][[1]]
Wan.2017.IJCancer   <- gsign_kidney["Wan.2017.IJCancer","signature"][[1]]
Zhan.2015.CMMM <- gsign_kidney["Zhan.2015.CMMM","signature"][[1]]
Dai.2016.Oncotarget <- gsign_kidney["Dai.2016.Oncotarget","signature"][[1]]
YuanLeiChen.2018.JCP <- gsign_kidney["YuanLeiChen.2018.JCP","signature"][[1]]
Hu.2019.IJMS <- gsign_kidney["Hu.2019.IJMS","signature"][[1]]
LiangChen.2018.JCP <- gsign_kidney["LiangChen.2018.JCP","signature"][[1]]
Wu.2019.FrontiersOnco <- gsign_kidney["Wu.2019.FrontiersOnco","signature"][[1]]
LingChen.2020.Hereditas <- gsign_kidney["LingChen.2020.Hereditas","signature"][[1]]
DCosta.2020.SciReports <- gsign_kidney["DCosta.2020.SciReports","signature"][[1]]


# use this function to make row or column names bold
# parameters:
#   mat: the matrix passed to pheatmap
#   rc_fun: either rownames or colnames
#   rc_names: vector of names that should appear in boldface
make_bold_names <- function(mat, rc_fun, rc_names) {
  bold_names <- rc_fun(mat)
  ids <- rc_names %>% match(rc_fun(mat))
  ids %>%
    walk(
      function(i)
        bold_names[i] <<-
        bquote(bold(.(rc_fun(mat)[i]))) %>%
        as.expression()
    )
  bold_names
}


source("../codes/GOChord.R")
```

# Chord mRMR

```{r message=FALSE, warning=FALSE, include=FALSE}

sets_list <- c("Rpart", "XGBoost", "Boruta", "RFE", "GBM", "mRMR") 

#Check the set genes intersected with mRMR
d <- genes_upset
target_cols <- c("mRMR")
other_cols <- colnames(d)[!(colnames(d) %in% c(sets_list, "gene", "genes_papers", "logFC.M0.M1", "logFC.NT.TP", "nlog10FDR.M0.M1", "nlog10FDR.NT.TP"))]
cols_sets <- d %>% filter_at(vars(all_of(target_cols)), ~.==1) %>% select_at(vars(any_of(other_cols))) %>%  colSums(.) > 0
cols_sets <- names(cols_sets)[cols_sets]

circ_dcols <- c("Category","ID","Term","Genes","adj_pval")

circ_data <- as.data.frame(matrix(nrow = length(cols_sets), ncol = length(circ_dcols)))

for(i in c(1:length(cols_sets)) ){
  circ_data[i,] <- list("X", cols_sets[i],cols_sets[i], paste0( get(cols_sets[i]), collapse=", "), 0 )
}

names(circ_data) <- circ_dcols
mRMR <- setdiff(mRMR, c("age"))

circ_genelist <- as.data.frame(matrix(nrow = length(mRMR), ncol = 2))

genes_matrix <- genes_upset
rownames(genes_matrix) <- genes_upset$gene

circ_genelist <- genes_matrix[mRMR, c("gene", "nlog10FDR.M0.M1")]
rownames(circ_genelist) <- circ_genelist$gene
colnames(circ_genelist) <- c("ID", "logFC")

# Generate the plotting object
circ <- circle_dat(circ_data, circ_genelist)

# Create the plot
chord <- chord_dat(data = circ, genes = circ_genelist, process = circ_data$ID)

chord  <- cbind(chord, genes_matrix[rownames(chord),"logFC.NT.TP"])

# rownames(chord) <-  fct_recode(rownames(chord),
#     "LIMCH1*" = "LIMCH1", 
#     "AL353637.1*" = "AL353637.1", 
#     "AL138830.2*" = "AL138830.2", 
#     "VSX1*" = "VSX1", 
#     "MICG*" = "MICG", 
#     "KISS1*" = "KISS1", 
#     "DPP6*" = "DPP6", 
#     "FOXJ1*" = "FOXJ1", 
#     "HHLA2*"= "HHLA2"
# )

p1 <- UpSetR::upset(genes_upset, sets = union(target_cols, cols_sets ), 
      main.bar.color = "#003147", 
      shade.color = "#7CCBA2", 
      cutoff = 0,
      text.scale = 1.5, 
      order.by = "freq", 
      set_size.show = TRUE, 
      set_size.numbers_size = 7,
      set_size.scale_max = 2200, 
      mb.ratio = c(0.4, 0.6))

p2 <- GOChordnew(chord,
        gene.order = 'logFC',
        nlfc = 2,
        gene.size = 3.2, 
        gene.space = 0.22,
        space = 0.01,  
        border.size= 0.000001, 
        process.label = 8,
        ribbon.col = c('#FF1F5B','#009ADE', '#00CD6C', '#AF58BA' , '#FFC61E', '#F28522', '#A0B1BA'),  #, '#A6761D', DC3977
        lfc.col=c('#CF597E','#E9E29C','#009392'))

grid.newpage()
p1
grid.edit('arrange',name='arrange2') 
vp1 = grid.grab()

grid.newpage()
p2
vp2 = grid.grab()

pdf("../plots/fig_2_chord_mRMR.pdf", width = 10, height = 15)
fg3a <- cowplot::plot_grid(
    vp1,  vp2,
    ncol = 1,
    labels = c("A", "C"),
    rel_heights = c(0.4, 1)
    )
dev.off()


grDevices::svg(file="../plots/fig3_chord_mRMR.svg",width = 10, height = 15)
  cowplot::plot_grid(
    vp1,  vp2,
    ncol = 1,
    labels = "AUTO",
    rel_heights = c(0.4, 1)
    )
dev.off()

```


# Plotting survival curves

```{r}
rm(list=setdiff(ls(), "gsign_kidney"))

load("../data/1.data.processed.rda")

data.filt <- data[data$obs.time > 20 & data$obs.time < 2555, ]
data_tcga <- data[data$dataset =="TCGA", ]
data_icgc <- data[data$dataset =="ICGC", ]
data_icgc.filt <- data.filt[data.filt$dataset =="ICGC", ]



```

```{r}

# Compute Survival KM ----
#col_sign <- intersect(gsign_kidney["mRMR", "signature"][[1]], names(data))

#col_sign <- c("age", "AL353637.1", "AR",  "DPP6", "FOXJ1", "FOXJ1", "GNB3", "HHLA2", "IL4", "LIMCH1", "LINC01732", "OTX1", "SAA1", "SEMA3G", "ZIC2")
col_sign <- c("age", "AR", "AL353637.1", "FOXJ1", "LINC01732", "SEMA3G",  "HHLA2")
col_sign <- c("AR", "FOXJ1", "LINC01732", "SEMA3G",  "MT1G")
set.seed(12) ## for reproducibility
  
fold1 <- sample(1:nrow(data_tcga),size=floor(nrow(data_tcga)/3))
fold2 <- sample(setdiff(1:nrow(data_tcga), fold1), size=floor(nrow(data_tcga)/3))
fold3 <- setdiff(1:nrow(data_tcga), union(fold1,fold2))

x <- (data_tcga[, col_sign] +1)
y <- Surv(data_tcga$obs.time, data_tcga$status)
y_tr <- y[-fold1]
x_tr <- x[-fold1,]
y_te <- y[fold1]
x_te <- x[fold1,]

set.seed(12) 
cvfit_tr <- cv.glmnet(data.matrix(x_tr),y_tr, nfolds=5, gamma = 1, relax = T, family="cox", type.measure="C")
preds <- predict(cvfit_tr,data.matrix(x_te), s="lambda.min")
levs_tcga <- cut_number(preds,3)
levs_tcga <- as.character(as.numeric(levs_tcga))
x_te$risk <- fct_relevel(fct_recode(levs_tcga, Low = "1", Moderate = "2", High = "3"), "High", "Moderate", "Low")

fit <- survfit(y_te~levs_tcga)
out <- survdiff(y_te~levs_tcga)
p.val <- 1 - pchisq(out$chisq, length(out$n) - 1)

times <- seq(10, 4000, 10)   # 2555               
AUC_Uno <- AUC.uno(y_tr, y_te, preds, times)
auc_uno <- AUC_Uno$iauc
  
km_data <- surv_fit(y_te ~ risk, data = cbind(x_te,y_te))
 
psurv_mRMR <-  ggsurvplot(km_data, conf.int = FALSE, data =  cbind(x_te,y_te), fun = NULL,
    #fontsize = 11,
    ggtheme = theme_grey(), 
    palette = c("red3", "orange1", "green4"),
    title = paste0("Survival prediction with mRMR genes on TCGA-KIRC\nTraining with 66% / Testing with 33% / AUC-Uno: ", signif(auc_uno, 2)),
    
    risk.table.y.text = FALSE,
    risk.table.title = "Nº at risk (nº of deceased)",
    tables.height = 0.25,
    risk.table = "nrisk_cumevents",
    pval = paste0("p-val: ", signif(p.val, 3)) )

# Compute PCA  -----
library(factoextra)
library(FactoMineR)

set.seed(12) 
res.pca <- PCA(data_tcga[fold1, col_sign], graph = FALSE)

status <- as.factor(ifelse(data_tcga$status[fold1]==1, "Deceased", "Alive"))
risk <- fct_relevel(fct_recode(levs_tcga, Low = "1", Moderate = "2", High = "3"), "High", "Moderate", "Low")

tb <- as.data.frame.matrix(table(risk,status))
data.tb <- tibble(x = Inf, y = -Inf, 
                      tb = list(tb))

    
tt <- ttheme_default(core=list(fg_params=list(hjust=0, x=0.1)),
                     rowhead=list(fg_params=list(col="orange", fontface=3L)),
                              rowhead=list(fg_params=list(hjust=0, x=0)))
    
p_pca <- fviz_pca_ind(res.pca,
             label = "none", # hide individual labels
             habillage = risk, # color by groups
             #habillage = status, # color by groups
             show.clust.cent = FALSE,
             palette = c("red3", "orange1", "green4"),
             addEllipses = TRUE, 
             ellipse.level = 0.95,
             ellipse.type ="confidence",
             ggtheme = theme_grey(),
             title = "PCA with mRMR genes on TCGA-KIRC predicted samples\n") + 
  geom_rug(sides="b", aes(color = risk)) +
  geom_table(data = data.tb, aes(x, y, label = tb), 
             table.theme = ttheme_gtlight,
             table.rownames = T, 
             size = 4,
             show.legend = T,
             hjust = 1, vjust = -0.25
             ) + 
  theme(legend.position="top")



p_mRMR <- plot_grid(psurv_mRMR$plot, psurv_mRMR$table,  ncol = 1, rel_heights = c(1, 0.4))

pcow <- cowplot::plot_grid(
    p_mRMR, NULL,  p_pca,
    ncol = 3,
    rel_widths = c(0.8,0.1, 1),
    labels = c("a","", "b")
  )
  
pcow


```




```{r}

splots <- list()
splots_auc <- list()
splots_gpca <- list()

i <- 1
sign <- "mRMR"
#data <- data_bkp
#data <- data.filt

#data <- data[data$obs.time > 20 & data$obs.time < 2555, ]
  #col_sign <- intersect(gsign_kidney["mRMR", "signature"][[1]], names(data))
  #col_sign <- c("AR", "AL353637.1", "FOXJ1", "LINC01732", "SEMA3G",  "HHLA2")
  col_sign <- c("age", "AL353637.1", "DPP6", "FOXJ1", "GNB3", "HHLA2", "IL4", "LIMCH1", "OTX1", "SAA1", "ZIC2")
  col_sign <- c("AR", "FOXJ1", "LINC01732", "SEMA3G",  "MT1G")
  #print(col_sign)
  set.seed(12) ## for reproducibility
    
  fold1 <- c(1:nrow(data))[data$dataset == "ICGC"]
  
  x <- (data[, col_sign] +1)
  y <- Surv(data$obs.time, data$status)
  y_tr <- y[-fold1]
  x_tr <- x[-fold1,]
  y_te <- y[fold1]
  x_te <- x[fold1,]
  
  set.seed(12) 
  cvfit_tr <- cv.glmnet(data.matrix(x_tr),y_tr, nfolds=5, gamma = 1, relax = T, family="cox", type.measure="C")
  preds <- predict(cvfit_tr,data.matrix(x_te), s="lambda.min")
  levs <- cut_number(preds,3)
  levs <- as.character(as.numeric(levs))
  x_te$risk <- fct_relevel(fct_recode(levs, Low = "1", Moderate = "2", High = "3"), "High", "Moderate", "Low")
  
  fit <- survfit(y_te~levs)
  out <- survdiff(y_te~levs)
  p.val <- 1 - pchisq(out$chisq, length(out$n) - 1)
  p.val
  times <- seq(10, 2000, 10)   # 4000               
  AUC_Uno <- AUC.uno(y_tr, y_te, preds, times)
  auc_uno <- AUC_Uno$iauc
  auc_uno  
  km_data <- surv_fit(y_te ~ risk, data = cbind(x_te,y_te))
   
  psurv_mRMR_icgc  <-  ggsurvplot(km_data, conf.int = FALSE, data =  x_te, fun = NULL,
      # fontsize = 12,
      ggtheme = theme_grey(), 
      palette = c("red3", "orange1", "green4"),
      #title = "Survival prediction with mRMR genes\n(train TCGA-KIRC / test ICGC-RECA / auc_uno: round(auc_uno, digits = 2))",
      title = paste0("Survival prediction with mRMR genes\nTraining with TCGA-KIRC / Testing with ICGC-RECA / AUC-Uno: ", round(auc_uno, digits = 2)),
      #title = paste0("Signature ", sign ," / p-val: ", signif(p.val, 3), " / auc_uno: ", round(auc_uno, digits = 2)),
      risk.table.y.text = FALSE,
      risk.table.title = "Nº at risk (nº of deceased)",
      tables.height = 0.25,
      risk.table = "nrisk_cumevents",
      pval = paste0("p-val: ", signif(p.val, 3)))
  

    # ##AUC
    survivalROC_helper <- function(t) {

        survivalROC(Stime    = data$obs.time[fold1],
                    status   = data$status[fold1],
                    marker   = preds,
                    predict.time = t,
                    method       = "NNE",
                    span = 0.25 * length(fold1)^(-0.20))
    }
    labels_obs.time <- c("2555" = "7 years", "3650" = "10 years", "4000" = "12 years" )
    ## Evaluate every 3650 days
    survivalROC_data <- tibble(t = c(2555)) %>%
        dplyr::mutate(survivalROC = purrr::map(t, survivalROC_helper),
               ## Extract scalar AUC
               auc = map_dbl(survivalROC, magrittr::extract2, "AUC"),
               ## Put cut off dependent values in a data_frame
               df_survivalROC = purrr::map(survivalROC, function(obj) {
                   as_tibble(obj[c("cut.values","TP","FP")])
               })) %>%
        dplyr::select(-survivalROC) %>%
        unnest(cols = c(df_survivalROC)) %>%
        arrange(t, FP, TP)
    
    ## Plot AUC
    splots_auc[[i]] <- survivalROC_data %>%
        ggplot(mapping = aes(x = FP, y = TP)) +
        ggtitle(paste0("AUC of ",  sign, " (train TCGA-KIRC / test ICGC-RECA)")) +
        geom_point() +
        geom_line() +
        geom_label(data = survivalROC_data %>% dplyr::select(t,auc) %>% unique,
                   mapping = aes(label = sprintf("%.2f", auc)), x = 0.5, y = 0.5) +
        facet_wrap( ~ t, labeller = as_labeller(labels_obs.time),  ncol = 4) +
        theme_bw() +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
              legend.key = element_blank(),
              plot.title = element_text(hjust = 0.5),
              strip.background = element_blank())

# Compute PCA  -----
library(factoextra)
library(FactoMineR)


res.pca_icgc <- PCA(data[fold1, col_sign], graph = FALSE)

status <- as.factor(ifelse(data$status[fold1]==1, "Deceased", "Alive"))
risk <- fct_relevel(fct_recode(levs, Low = "1", Moderate = "2", High = "3"), "High", "Moderate", "Low")

tb <- as.data.frame.matrix(table(risk,status))
data.tb <- tibble(x = Inf, y = -Inf, 
                      tb = list(tb))

    
tt <- ttheme_default(core=list(fg_params=list(hjust=0, x=0.1)),
                     rowhead=list(fg_params=list(col="orange", fontface=3L)),
                              rowhead=list(fg_params=list(hjust=0, x=0)))
    
p_pca_icgc <- fviz_pca_ind(res.pca_icgc,
             label = "none", # hide individual labels
             habillage = risk, # color by groups
             #habillage = status, # color by groups
             show.clust.cent = FALSE,
             palette = c("red3", "orange1", "green4"),
             addEllipses = TRUE, 
             ellipse.level = 0.95,
             ellipse.type ="confidence",
             ggtheme = theme_grey(),
             title = "PCA with mRMR genes on ICGC-RECA\n") + 
  geom_rug(sides="b", aes(color = risk)) +
  geom_table(data = data.tb, aes(x, y, label = tb), 
             table.theme = ttheme_gtlight,
             table.rownames = T, 
             size = 4,
             show.legend = T,
             hjust = 1, vjust = -0.25
             ) + 
  theme(legend.position="top")



p_mRMR_icgc <- plot_grid(psurv_mRMR_icgc$plot, psurv_mRMR_icgc$table,  ncol = 1, rel_heights = c(1, 0.4))



pcow_icgc <- cowplot::plot_grid(
    p_mRMR_icgc, NULL,  p_pca_icgc,
    ncol = 3,
    rel_widths = c(0.8,0.1, 1),
    labels = c("c","", "d")
  )

  

#pdf("../plots/fig_3_a_d_surv_pca.pdf", width = 16, height = 11)
  cowplot::plot_grid(
    pcow,
    pcow_icgc,
    ncol = 1
    )
#dev.off()
  
```



## Train 66% of TCGA, test holdout 33% of TCGA


```{r message=FALSE, warning=FALSE, include=FALSE}
if(!require('survC1')) {install.packages('survC1')} #
if(!require('survAUC')) {install.packages('survAUC')}
if(!require('survival')) {install.packages('survival')} 
if(!require('survminer')) {install.packages('survminer')} 
if(!require('survivalROC')) {install.packages('survivalROC')} 
if(!require('ggpmisc')) {install.packages('ggpmisc')} 
if(!require('glmpca')) {install.packages('glmpca')} 
if(!require('glmnet')) {install.packages('glmnet')} 
# library(stats) # MDS
# library(ggplot2)
# library(ggfortify)
# library(gbm)
# library(mboost)
# library(finalfit)
  
# genes_sets <-  c("Rpart", "XGBoost", "GBM", "Boruta", "RFE", "mRMR", 
#                  "Ha.2014.CaInfo", "Zhan.2015.CMMM", "Dai.2016.Oncotarget", "Wan.2017.IJCancer", "Chang.2018.Medicine", "YuanLeiChen.2018.JCP", "Hu.2019.IJMS", 
#                  "LiangChen.2018.JCP", "Pan.2019.MSM", "Wu.2019.FrontiersOnco", "Jiang.2020.ACS", "Zou.2020.PeerJ", "LingChen.2020.Hereditas", "DCosta.2020.SciReports") 

genes_sets <-  c("mRMR")

# List of ggsurvplots
splots <- list()
splots_auc <- list()
splots_gpca <- list()
i <- 1
  
for(sign in  genes_sets) {
  print(sign)
  col_sign <- intersect(gsign_kidney[sign, "signature"][[1]], names(data))
  #print(col_sign)
  set.seed(42) ## for reproducibility
    
  fold1 <- sample(1:nrow(data_tcga),size=floor(nrow(data_tcga)/3))
  fold2 <- sample(setdiff(1:nrow(data_tcga), fold1), size=floor(nrow(data_tcga)/3))
  fold3 <- setdiff(1:nrow(data_tcga), union(fold1,fold2))
  
  x <- (data_tcga[, col_sign] +1)
  y <- Surv(data_tcga$obs.time, data_tcga$status)
  y_tr <- y[-fold1]
  x_tr <- x[-fold1,]
  y_te <- y[fold1]
  x_te <- x[fold1,]
  
  set.seed(42) 
  cvfit_tr <- cv.glmnet(data.matrix(x_tr),y_tr, nfolds=5, gamma = 0, relax = T, family="cox", type.measure="C")
  preds <- predict(cvfit_tr,data.matrix(x_te), s="lambda.min")
  levs <- cut_number(preds,3)
  levs <- as.character(as.numeric(levs))
  x_te$risk <- fct_relevel(fct_recode(levs, Low = "1", Moderate = "2", High = "3"), "High", "Moderate", "Low")
  
  fit <- survfit(y_te~levs)
  out <- survdiff(y_te~levs)
  p.val <- 1 - pchisq(out$chisq, length(out$n) - 1)
  
  times <- seq(10, 3555, 10)   # 2555               
  AUC_Uno <- AUC.uno(y_tr, y_te, preds, times)
  auc_uno <- AUC_Uno$iauc
    
  km_data <- surv_fit(y_te ~ risk, data = cbind(x_te,y_te))
   
  splots[[i]] <-  ggsurvplot(km_data, conf.int = FALSE, data =  cbind(x_te,y_te), fun = NULL,
      #fontsize = 11,
      ggtheme = theme_grey(), 
      palette = c("red3", "orange1", "green4"),
      title = paste0("Survival prediction ", sign , " on TCGA-KIRC (66% train / 33% test)"),
      risk.table.y.text = FALSE,
      risk.table.title = "Nº at risk (nº of deceased)",
      tables.height = 0.25,
      risk.table = "nrisk_cumevents",
      pval = paste0("p-val: ", signif(p.val, 3)) )

    ##AUC
    survivalROC_helper <- function(t) {
      
        survivalROC(Stime    = data_tcga$obs.time[fold1],
                    status   = data_tcga$status[fold1],
                    marker   = preds,
                    predict.time = t,
                    method       = "NNE",
                    span = 0.25 * length(fold1)^(-0.20))
    }
    labels_obs.time <- c("3555" = "10 years")
    ## Evaluate 4000 days
    survivalROC_data <- tibble(t = c(3555)) %>%
        dplyr::mutate(survivalROC = purrr::map(t, survivalROC_helper),
               ## Extract scalar AUC
               auc = map_dbl(survivalROC, magrittr::extract2, "AUC"),
               ## Put cut off dependent values in a data_frame
               df_survivalROC = purrr::map(survivalROC, function(obj) {
                   as_tibble(obj[c("cut.values","TP","FP")])
               })) %>%
        dplyr::select(-survivalROC) %>%
        unnest(cols = c(df_survivalROC)) %>%
        arrange(t, FP, TP)
    
    ## Plot AUC
    splots_auc[[i]] <- survivalROC_data %>%
        ggplot(mapping = aes(x = FP, y = TP)) +
        ggtitle(paste0("AUC of ",  sign, " on TCGA-KIRC (66% train / 33% test)")) +
        geom_point() +
        geom_line() +
        geom_label(data = survivalROC_data %>% dplyr::select(t,auc) %>% unique,
                   mapping = aes(label = sprintf("%.2f", auc)), x = 0.5, y = 0.5) +
        facet_wrap( ~ t, labeller = as_labeller(labels_obs.time),  ncol = 4) +
        theme_bw() +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
              legend.key = element_blank(),
              plot.title = element_text(hjust = 0.5),
              strip.background = element_blank())
    
    ## Plot GPCA
    df <- as.data.frame(t(data_tcga[fold1, col_sign]))
    df <- df[apply(df[,-1], 1, function(x) !all(x==0)),]
    df <- (df+1)
    set.seed(12) 
    gpca <- glmpca(df, L=2, fam="nb2")
    gpca.dat <- gpca$factors
    gpca.dat$risk <- x_te$risk 
    gpca.dat$status <- ifelse(data_tcga$status[fold1]==1, "Deceased", "Alive")
    
    tb <- as.data.frame.matrix(table(gpca.dat$status, gpca.dat$risk))
    data.tb <- tibble(x = Inf, y = Inf, tb = list(tb))
  
   splots_gpca[[i]] <- ggplot(gpca.dat, aes(x=dim1, y=dim2, shape = status, color = risk)) +
    geom_point() +
    geom_rug() +
     ggtitle(paste0("glmPCA on TCGA-KIRC expression of ",  sign, " genes")) +
    xlab("PC1") +
    ylab("PC2") +
    theme(plot.title = element_text(hjust = 0.5))+
    #coord_fixed(ratio = sd_ratio) +
    scale_shape_manual(values = c(15,4)) + 
    #scale_color_manual(values = c("#AF58BA", "#00CD6C")) + theme(aspect.ratio = 1) + 
    scale_color_manual(values = c("red3", "orange1", "green4")) + theme(aspect.ratio = 1) + 
    geom_table(data = data.tb, aes(x, y, label = tb), table.rownames = T, hjust = 1, vjust = 1) 
    #ggsave(paste0("../plots/icgc_3_cut/gpca_icgc_", sign , ".pdf"), width = 11, height = 7, units = c("in"))
  splots_gpca[[i]]
  
    i <- i+1
}  

```


```{r}
library(cowplot)

p_Rpart <- plot_grid(splots[[1]]$plot, splots[[1]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_XGBoost <- plot_grid(splots[[2]]$plot, splots[[2]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_GBM <- plot_grid(splots[[3]]$plot, splots[[3]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_Boruta <- plot_grid(splots[[4]]$plot, splots[[4]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_RFE <- plot_grid(splots[[5]]$plot, splots[[5]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_mRMR <- plot_grid(splots[[6]]$plot, splots[[6]]$table,  ncol = 1, rel_heights = c(1, 0.4))

p_7 <- plot_grid(splots[[7]]$plot, splots[[7]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_8 <- plot_grid(splots[[8]]$plot, splots[[8]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_9 <- plot_grid(splots[[9]]$plot, splots[[9]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_10 <- plot_grid(splots[[10]]$plot, splots[[10]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_11 <- plot_grid(splots[[11]]$plot, splots[[11]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_12 <- plot_grid(splots[[12]]$plot, splots[[12]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_13 <- plot_grid(splots[[13]]$plot, splots[[13]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_14 <- plot_grid(splots[[14]]$plot, splots[[14]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_15 <- plot_grid(splots[[15]]$plot, splots[[15]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_16 <- plot_grid(splots[[16]]$plot, splots[[16]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_17 <- plot_grid(splots[[17]]$plot, splots[[17]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_18 <- plot_grid(splots[[18]]$plot, splots[[18]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_19 <- plot_grid(splots[[19]]$plot, splots[[19]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_20 <- plot_grid(splots[[20]]$plot, splots[[20]]$table,  ncol = 1, rel_heights = c(1, 0.4))


pdf("../plots/fig6a_c_auc_surv_gpca.pdf", width = 20, height = 5.5)
  cowplot::plot_grid(
    splots_auc[[6]],  p_mRMR,  splots_gpca[[6]],
    ncol = 3,
    rel_widths = c(0.7, 0.9, 1),
    labels = c("A", "B", "C")
  )
dev.off()

pdf("../plots/fig_auc_surv_gpca_tcga_genes1.pdf", width = 44, height = 57.2)
  cowplot::plot_grid(
    splots_auc[[3]],  p_GBM, splots_gpca[[3]], splots_auc[[5]],  p_RFE, splots_gpca[[5]],
    splots_auc[[2]],  p_XGBoost, splots_gpca[[2]], splots_auc[[4]],  p_Boruta, splots_gpca[[4]],
    splots_auc[[1]],  p_Rpart, splots_gpca[[1]], splots_auc[[7]],  p_7, splots_gpca[[7]], 
    splots_auc[[8]],  p_8, splots_gpca[[8]], splots_auc[[9]],  p_9, splots_gpca[[9]],
    splots_auc[[10]],  p_10, splots_gpca[[10]], splots_auc[[11]],  p_11, splots_gpca[[11]], 
    splots_auc[[12]],  p_12, splots_gpca[[12]], splots_auc[[13]],  p_13, splots_gpca[[13]], 
    splots_auc[[14]],  p_14, splots_gpca[[14]], splots_auc[[15]],  p_15, splots_gpca[[15]],
    splots_auc[[16]],  p_16, splots_gpca[[16]], splots_auc[[17]],  p_17, splots_gpca[[17]],
    splots_auc[[18]],  p_18, splots_gpca[[18]], splots_auc[[19]],  p_19, splots_gpca[[19]],
     splots_auc[[20]],  p_20, splots_gpca[[20]], NULL, NULL, NULL, 
    labels = c("1A", "1B", "1C", "2A", "2B", "2C",
               "3A", "3B", "3C", "4A", "4B", "4C",
               "5A", "5B", "5C", "6A", "6B", "6C",
               "7A", "7B", "7C", "8A", "8B", "8C",
               "9A", "9B", "9C", "10A", "10B", "10C",
               "11A", "11B", "11C", "12A", "12B", "12C",
               "13A", "13B", "13C", "14A", "14B", "14C",
               "15A", "15B", "15C", "16A", "16B", "16C",
               "17A", "17B", "17C", "18A", "18B", "18C",
               "19A", "19B", "19C", "","",""),
    ncol = 6,
    rel_widths = c(0.7, 0.8, 1,0.7, 0.8, 1)
  )
dev.off()

```



## Train TCGA, test ICGC


```{r message=FALSE, warning=FALSE, include=FALSE}
library(survC1)
library(survAUC)

library(survival) 
library(survminer) # ggsurvplot

library(survivalROC)
library(ggpmisc) # geom_table
# library(stats) # MDS
# library("glmpca")
# library(ggplot2)
# library(ggfortify)
# library(survC1)
# library(survAUC)
# library(glmnet)
# library(gbm)
# library(mboost)
# library(finalfit)
# 
# gsign_kidney["RFE", "signature"][[1]] <- list(setdiff(gsign_kidney["RFE", "signature"][[1]], c("SAA2", "SAA4", "NUF2", "KIF18B", "AURKB", "TROAP", "NEIL3", "TRIP13")))
#     
# gsign_kidney["Boruta", "signature"][[1]] <- list(setdiff(gsign_kidney["Boruta", "signature"][[1]], c("SLC18A3", "AGAP6", "TROAP", "AURKB","KIF18B","CCNF")))
# 
# gsign_kidney["Rpart", "signature"][[1]] <- list(setdiff(gsign_kidney["Rpart", "signature"][[1]], c("AC084117.1", "KIF18B", "AURKB", "TROAP", "FOXM1", "MYBL2", "G6PC", "C17orf80")))
# 
# gsign_kidney["GBM", "signature"][[1]] <- list(setdiff(gsign_kidney["GBM", "signature"][[1]], c("AC084117.1", "CCDC154")))
# 
# gsign_kidney["mRMR", "signature"][[1]] <- list(setdiff(gsign_kidney["mRMR", "signature"][[1]], c("SLC16A12", "AC093001.1")))


  
genes_sets <-  c("Rpart", "XGBoost", "GBM", "Boruta", "RFE", "mRMR", 
                 "Ha.2014.CaInfo", "Zhan.2015.CMMM", "Dai.2016.Oncotarget", "Wan.2017.IJCancer", 
                 "Chang.2018.Medicine", "YuanLeiChen.2018.JCP", "Hu.2019.IJMS", "LiangChen.2018.JCP", 
                 "Pan.2019.MSM", "Wu.2019.FrontiersOnco", "Jiang.2020.ACS", "Zou.2020.PeerJ", 
                 "LingChen.2020.Hereditas", "DCosta.2020.SciReports") 


# List of ggsurvplots
splots <- list()
splots_auc <- list()
splots_gpca <- list()
i <- 1
  
for(sign in  genes_sets) {
  print(sign)
  col_sign <- intersect(gsign_kidney[sign, "signature"][[1]], names(data))
  #print(col_sign)
  set.seed(12) ## for reproducibility
    
  fold1 <- c(1:nrow(data))[data$dataset == "ICGC"]
  
  x <- (data[, col_sign] +1)
  y <- Surv(data$obs.time, data$status)
  y_tr <- y[-fold1]
  x_tr <- x[-fold1,]
  y_te <- y[fold1]
  x_te <- x[fold1,]
  
  set.seed(12) 
  cvfit_tr <- cv.glmnet(data.matrix(x_tr),y_tr, nfolds=5, gamma = 0, relax = T, family="cox", type.measure="C")
  preds <- predict(cvfit_tr,data.matrix(x_te), s="lambda.min")
  levs <- cut_number(preds,3)
  levs <- as.character(as.numeric(levs))
  x_te$risk <- fct_relevel(fct_recode(levs, Low = "1", Moderate = "2", High = "3"), "High", "Moderate", "Low")
  
  fit <- survfit(y_te~levs)
  out <- survdiff(y_te~levs)
  p.val <- 1 - pchisq(out$chisq, length(out$n) - 1)
  
  times <- seq(10, 2555, 10)   # 4000               
  AUC_Uno <- AUC.uno(y_tr, y_te, preds, times)
  auc_uno <- AUC_Uno$iauc
    
  km_data <- surv_fit(y_te ~ risk, data = cbind(x_te,y_te))
   
  splots[[i]] <-  ggsurvplot(km_data, conf.int = FALSE, data =  cbind(x_te,y_te), fun = NULL,
      # fontsize = 12,
      ggtheme = theme_grey(), 
      palette = c("red3", "orange1", "green4"),
      title = paste0("Prediction ", sign , " (train TCGA-KIRC / test ICGC-RECA)"),
      #title = paste0("Signature ", sign ," / p-val: ", signif(p.val, 3), " / auc_uno: ", round(auc_uno, digits = 2)),
      risk.table.y.text = FALSE,
      risk.table.title = "Nº at risk (nº of deceased)",
      tables.height = 0.25,
      risk.table = "nrisk_cumevents",
      pval = paste0("p-val: ", signif(p.val, 3)))

    ##AUC
    survivalROC_helper <- function(t) {
      
        survivalROC(Stime    = data$obs.time[fold1],
                    status   = data$status[fold1],
                    marker   = preds,
                    predict.time = t,
                    method       = "NNE",
                    span = 0.25 * length(fold1)^(-0.20))
    }
    labels_obs.time <- c("2555" = "7 years")
    ## Evaluate every 3650 days
    survivalROC_data <- tibble(t = c(2555)) %>%
        dplyr::mutate(survivalROC = purrr::map(t, survivalROC_helper),
               ## Extract scalar AUC
               auc = map_dbl(survivalROC, magrittr::extract2, "AUC"),
               ## Put cut off dependent values in a data_frame
               df_survivalROC = purrr::map(survivalROC, function(obj) {
                   as_tibble(obj[c("cut.values","TP","FP")])
               })) %>%
        dplyr::select(-survivalROC) %>%
        unnest(cols = c(df_survivalROC)) %>%
        arrange(t, FP, TP)
    
    ## Plot AUC
    splots_auc[[i]] <- survivalROC_data %>%
        ggplot(mapping = aes(x = FP, y = TP)) +
        ggtitle(paste0("AUC of ",  sign, " (train TCGA-KIRC / test ICGC-RECA)")) +
        geom_point() +
        geom_line() +
        geom_label(data = survivalROC_data %>% dplyr::select(t,auc) %>% unique,
                   mapping = aes(label = sprintf("%.2f", auc)), x = 0.5, y = 0.5) +
        facet_wrap( ~ t, labeller = as_labeller(labels_obs.time),  ncol = 4) +
        theme_bw() +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
              legend.key = element_blank(),
              plot.title = element_text(hjust = 0.5),
              strip.background = element_blank())
    
    ## Plot GPCA
    df <- as.data.frame(t(data[fold1, col_sign]))
    df <- df[apply(df[,-1], 1, function(x) !all(x==0)),]
    df <- (df+1)
    set.seed(12) 
    gpca <- glmpca(df, L=2, fam="nb2")
    gpca.dat <- gpca$factors
    gpca.dat$risk <- x_te$risk 
    gpca.dat$status <- ifelse(data$status[fold1]==1, "Deceased", "Alive")
    
    tb <- as.data.frame.matrix(table(gpca.dat$status, gpca.dat$risk))
    data.tb <- tibble(x = Inf, y = Inf, tb = list(tb))
  
   splots_gpca[[i]] <- ggplot(gpca.dat, aes(x=dim1, y=dim2, shape = status, color = risk)) +
    geom_point() +
    geom_rug() +
     ggtitle(paste0("glmPCA on ICGC-RECA expression of ",  sign, " genes")) +
    #ggtitle(paste0("Generalized PCA of ICGC data expression with ",  sign, " / p-val: ", signif(p.val, digits = 3), " / auc: ", round(auc_uno, digits = 2))) +
    xlab("PC1") +
    ylab("PC2") +
    #xlab(paste0("PC1, VarExp: ", gpca[1], "%")) +
    #ylab(paste0("PC2, VarExp: ", gpca[2], "%")) +
    theme(plot.title = element_text(hjust = 0.5))+
    #coord_fixed(ratio = sd_ratio) +
    scale_shape_manual(values = c(15,4)) + 
    #scale_color_manual(values = c("#AF58BA", "#00CD6C")) + theme(aspect.ratio = 1) + 
    scale_color_manual(values = c("red3", "orange1", "green4")) + theme(aspect.ratio = 1) + 
    geom_table(data = data.tb, aes(x, y, label = tb), table.rownames = T, hjust = 1, vjust = 1) 
    #ggsave(paste0("../plots/icgc_3_cut/gpca_icgc_", sign , ".pdf"), width = 11, height = 7, units = c("in"))
  splots_gpca[[i]]
  
    i <- i+1
}  

```




```{r}
library(cowplot)

p_Rpart <- plot_grid(splots[[1]]$plot, splots[[1]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_XGBoost <- plot_grid(splots[[2]]$plot, splots[[2]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_GBM <- plot_grid(splots[[3]]$plot, splots[[3]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_Boruta <- plot_grid(splots[[4]]$plot, splots[[4]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_RFE <- plot_grid(splots[[5]]$plot, splots[[5]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_mRMR <- plot_grid(splots[[6]]$plot, splots[[6]]$table,  ncol = 1, rel_heights = c(1, 0.4))

p_7 <- plot_grid(splots[[7]]$plot, splots[[7]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_8 <- plot_grid(splots[[8]]$plot, splots[[8]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_9 <- plot_grid(splots[[9]]$plot, splots[[9]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_10 <- plot_grid(splots[[10]]$plot, splots[[10]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_11 <- plot_grid(splots[[11]]$plot, splots[[11]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_12 <- plot_grid(splots[[12]]$plot, splots[[12]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_13 <- plot_grid(splots[[13]]$plot, splots[[13]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_14 <- plot_grid(splots[[14]]$plot, splots[[14]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_15 <- plot_grid(splots[[15]]$plot, splots[[15]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_16 <- plot_grid(splots[[16]]$plot, splots[[16]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_17 <- plot_grid(splots[[17]]$plot, splots[[17]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_18 <- plot_grid(splots[[18]]$plot, splots[[18]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_19 <- plot_grid(splots[[19]]$plot, splots[[19]]$table,  ncol = 1, rel_heights = c(1, 0.4))
p_20 <- plot_grid(splots[[20]]$plot, splots[[20]]$table,  ncol = 1, rel_heights = c(1, 0.4))


pdf("../plots/fig6d_f_auc_surv_gpca.pdf", width = 20, height = 5.5)
  cowplot::plot_grid(
    splots_auc[[6]],  p_mRMR,  splots_gpca[[6]],
    ncol = 3,
    rel_widths = c(0.7, 0.9, 1),
    labels = c("D", "E", "F")
  )
dev.off()

pdf("../plots/fig_auc_surv_gpca_icgc_genes1.pdf", width = 44, height = 57.2)
  cowplot::plot_grid(
    splots_auc[[3]],  p_GBM, splots_gpca[[3]], splots_auc[[5]],  p_RFE, splots_gpca[[5]],
    splots_auc[[2]],  p_XGBoost, splots_gpca[[2]], splots_auc[[4]],  p_Boruta, splots_gpca[[4]],
    splots_auc[[1]],  p_Rpart, splots_gpca[[1]], splots_auc[[7]],  p_7, splots_gpca[[7]], 
    splots_auc[[8]],  p_8, splots_gpca[[8]], splots_auc[[9]],  p_9, splots_gpca[[9]],
    splots_auc[[10]],  p_10, splots_gpca[[10]], splots_auc[[11]],  p_11, splots_gpca[[11]], 
    splots_auc[[12]],  p_12, splots_gpca[[12]], splots_auc[[13]],  p_13, splots_gpca[[13]], 
    splots_auc[[14]],  p_14, splots_gpca[[14]], splots_auc[[15]],  p_15, splots_gpca[[15]],
    splots_auc[[16]],  p_16, splots_gpca[[16]], splots_auc[[17]],  p_17, splots_gpca[[17]],
    splots_auc[[18]],  p_18, splots_gpca[[18]], splots_auc[[19]],  p_19, splots_gpca[[19]],
     splots_auc[[20]],  p_20, splots_gpca[[20]], NULL, NULL, NULL, 
    labels = c("1A", "1B", "1C", "2A", "2B", "2C",
               "3A", "3B", "3C", "4A", "4B", "4C",
               "5A", "5B", "5C", "6A", "6B", "6C",
               "7A", "7B", "7C", "8A", "8B", "8C",
               "9A", "9B", "9C", "10A", "10B", "10C",
               "11A", "11B", "11C", "12A", "12B", "12C",
               "13A", "13B", "13C", "14A", "14B", "14C",
               "15A", "15B", "15C", "16A", "16B", "16C",
               "17A", "17B", "17C", "18A", "18B", "18C",
               "19A", "19B", "19C", "","",""),
    ncol = 6,
    rel_widths = c(0.7, 0.8, 1,0.7, 0.8, 1)
  )
dev.off()

```


```{r message=FALSE, warning=FALSE, include=FALSE}
load(file = "../data/2.gsign_kidney.rda")
load(file = "../data/surv/3.data.benchmark_tcgadata_3cv_no_colinear.rda") # job_benchmark_grid.R 3.data.benchmark_tcgadata_3cv.rda

gsign_kidney <- gsign_kidney %>%
  dplyr::filter(!id %in% c("sign.3", "sign.4",  "sign.11", "sign.13", "sign.14", "fs.genetic", "fs.mRMR.status", "fs.mRMR.time")) %>%
  mutate(id =  fct_recode(id,
    Ha.2014.CaInfo = "sign.1",
    Zhan.2015.CMMM = "sign.2",
    Dai.2016.Oncotarget = "sign.5",
    Wan.2017.IJCancer = "sign.6",
    Chang.2018.Medicine = "sign.7",
    YuanLeiChen.2018.JCP = "sign.8",
    Hu.2019.IJMS = "sign.9",
    LiangChen.2018.JCP = "sign.10",
    #Pan.2019.MSM.5genes = "sign.11", # removed
    Pan.2019.MSM = "sign.12",
    Wu.2019.FrontiersOnco = "sign.15",
    Jiang.2020.ACS = "sign.16",
    Zou.2020.PeerJ = "sign.17",
    LingChen.2020.Hereditas = "sign.18",
    DCosta.2020.SciReports = "sign.19",
    Boruta = "fs.boruta",
    RFE = "fs.mlr.rfe",
    mRMR = "fs.mRMR"
    ))

rownames(gsign_kidney) <- gsign_kidney$id


load("../data/1.data.processed.rda")

#data.filt <- data[data$obs.time > 20 & data$obs.time < 2555, ]
data_tcga <- data[data$dataset =="TCGA", ]
data_icgc <- data[data$dataset =="ICGC", ]
#data_icgc.filt <- data.filt[data.filt$dataset =="ICGC", ]

sign <- gsign_kidney["mRMR", "signature"][[1]]
sign <- intersect(sign, setdiff(names(data_tcga), "age"))

df <- data_tcga[rownames(data_tcga)[order(data_tcga$status)],sign]

names(df) <- fct_recode(names(df),
    "LIMCH1*" = "LIMCH1", 
    "AL353637.1*" = "AL353637.1", 
    "AL138830.2*" = "AL138830.2", 
    "VSX1*" = "VSX1", 
    "MICG*" = "MICG", 
    "KISS1*" = "KISS1", 
    "DPP6*" = "DPP6", 
    "FOXJ1*" = "FOXJ1", 
    "HHLA2*"= "HHLA2"
)

# use this function to make row or column names bold
# parameters:
#   mat: the matrix passed to pheatmap
#   rc_fun: either rownames or colnames
#   rc_names: vector of names that should appear in boldface
make_bold_names <- function(mat, rc_fun, rc_names) {
  bold_names <- rc_fun(mat)
  ids <- rc_names %>% match(rc_fun(mat))
  ids %>%
    walk(
      function(i)
        bold_names[i] <<-
        bquote(bold(.(rc_fun(mat)[i]))) %>%
        as.expression()
    )
  bold_names
}


ann_heatmap <- data.frame(status = ifelse(data$status == 1, "deceased", "alive"), 
                          metastasis = data$metastasis,
                          dataset = data$dataset, 
                          # age = data$age,
                          ajcc.stage = data$ajcc.stage)

row.names(ann_heatmap) <- rownames(data)

ann_colors <- list(  
  status = c("#FF1F5B", "#009ADE"), #
  # age = RColorBrewer::brewer.pal(length(unique(data$ajcc.stage)), "Spectral"),
  metastasis = c("#F2ACCA", "#06592A", "yellow"),
  dataset = c("#045275", "#FFF3B2"),
  ajcc.stage = c("#FFF3B2", "#FFC61E", "#FF1F5B", "#009392")
)

names(ann_colors$status) <- unique(ifelse(data$status == 1, "deceased", "alive"))
names(ann_colors$metastasis) <- levels(data$metastasis)
names(ann_colors$dataset) <- unique(data$dataset)
names(ann_colors$ajcc.stage) <- c("T1", "T2", "T3", "T4")

library("pheatmap")

#pdf("../plots/fig_supl_heatmap_mRMR.pdf", width = 18, height = 12)
pheatmap(df, 
         labels_col = make_bold_names(df, colnames,  c("LIMCH1*", "AL353637.1*", "AL138830.2*", "VSX1*", "MICG*", "KISS1*", "DPP6*", "FOXJ1*", "HHLA2*")),
         annotation_row = ann_heatmap,
         annotation_colors = ann_colors,
         legend = TRUE, 
         scale = "row",
         #cluster_rows = FALSE,
         method = "centroid",
         show_rownames = FALSE,
         angle_col = 45,
         cutree_cols = 2,
         cutree_rows = 2)
#dev.off()
```


```{r}
library("pheatmap")

sign <- c("AR", "AL353637.1", "DPP6", "FOXJ1", "GNB3", "HHLA2", "IL4", "LIMCH1", "LINC01732", "OTX1", "SAA1", "SEMA3G", "ZIC2")

df0 <- data[rownames(data)[order(data$status)] ,]
df0 <-df0[df0$metastasis !="MX" & !is.na(df0$metastasis), ]
df <- df0[, sign]

#df <- data[rownames(data)[order(data$status)],sign]

ann_heatmap <- data.frame(status = ifelse(df0$status == 1, "deceased", "alive"), 
                          metastasis = df0$metastasis,
                          dataset = df0$dataset, 
                          # age = data$age,
                          ajcc.stage = df0$ajcc.stage)

row.names(ann_heatmap) <- rownames(df)

ann_colors <- list(  
  status = c("#FF1F5B", "#009ADE"), 
  metastasis = c("#F2ACCA", "#06592A"),
  dataset = c("#045275", "#FFF3B2"),
  ajcc.stage = c("#FFF3B2", "#FFC61E", "#FF1F5B", "#009392")
)


names(ann_colors$status) <- c("deceased", "alive")
names(ann_colors$metastasis) <- c("M0", "M1")
names(ann_colors$dataset) <- c("TCGA", "ICGC")
names(ann_colors$ajcc.stage) <- c("T1", "T2", "T3", "T4")

# method 	
#the agglomeration method to be used. This should be (an unambiguous abbreviation of) one of "ward.D", "ward.D2", "single", "complete", "average" (= UPGMA), "mcquitty" (= WPGMA), "median" (= WPGMC) or "centroid" (= UPGMC).

pdf("../plots/fig7_heatmap_mRMR_signature.pdf", width = 12, height = 9)
pheatmap(df, 
         colorRampPalette(c("navy", "white", "firebrick1"))(100),
         annotation_row = ann_heatmap,
         annotation_colors = ann_colors,
         legend = TRUE, 
         #cluster_rows = FALSE,
         #cluster_cols = FALSE,
         method = "average",
         clustering_distance_rows = "correlation",
         clustering_distance_cols = "correlation",
         #kmeans_k = 2,
         show_rownames = FALSE,
         angle_col = 45,
         cutree_cols = 2,
         cutree_rows = 2,
         scale = 'column')
dev.off()


```

```{r}


```



<!-- ```{r} -->


<!-- library(clusterProfiler) -->

<!-- library(DOSE) -->
<!-- data(geneList) -->
<!-- de <- names(geneList)[abs(geneList) > 2] -->

<!-- edo <- enrichDGN(de) -->
<!-- ## convert gene ID to Symbol -->
<!-- edox <- setReadable(edo, 'org.Hs.eg.db', 'ENTREZID') -->

<!-- p2 <- heatplot(edox, foldChange=geneList) -->
<!-- p2 -->
<!-- ``` -->



<!-- ```{r} -->
<!-- library("ggrepel") -->
<!-- # add a column with the names of only the top 10 genes -->
<!-- #cutoff <- sort(dea.M0.M1$pvalue) -->

<!-- shrink.deseq.cut <- dea.M0.M1 %>%  -->
<!--     mutate(TopGeneLabel=ifelse((symbol %in% gsign_kidney["mRMR", "signature"][[1]] & FDR < 0.05) & abs(logFC) > 1, symbol, "")) -->

<!-- ggplot(shrink.deseq.cut, aes(x = logFC, y= -log10(FDR))) +  -->
<!--   geom_point(aes(colour=FDR < 0.05), pch=20, size=2) + -->
<!--   labs(x="log Fold Change", y="-log10(FDR)") +  -->
<!--   geom_label_repel(aes(label=TopGeneLabel),  -->
<!--                    seed = 123, -->
<!--                    max.time = 5, -->
<!--                    max.iter = Inf, -->
<!--                    size = 3, -->
<!--                    box.padding = 2,  -->
<!--                    max.overlaps = Inf) -->

<!-- rm(shrink.deseq.cut, cutoff) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- library("ggrepel") -->
<!-- # add a column with the names of only the top 10 genes -->
<!-- #cutoff <- sort(dea.M0.M1$pvalue) -->

<!-- shrink.deseq.cut <- dea.NT.TP %>%  -->
<!--     mutate(TopGeneLabel=ifelse((symbol %in% gsign_kidney["mRMR", "signature"][[1]] & FDR < 0.05) & abs(logFC) > 3, symbol, "")) -->

<!-- ggplot(shrink.deseq.cut, aes(x = logFC, y= -log10(FDR))) +  -->
<!--   geom_point(aes(colour=FDR < 0.05), pch=20, size=2) + -->
<!--   labs(x="log Fold Change", y="-log10(FDR)") +  -->
<!--   geom_label_repel(aes(label=TopGeneLabel),  -->
<!--                    seed = 123, -->
<!--                    max.time = 5, -->
<!--                    max.iter = Inf, -->
<!--                    size = 3, -->
<!--                    box.padding = 2,  -->
<!--                    max.overlaps = Inf) -->

<!-- rm(shrink.deseq.cut, cutoff) -->
<!-- ``` -->



