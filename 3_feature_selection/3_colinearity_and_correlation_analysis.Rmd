---
title: "R Notebook - Supplementary Figures: Collinearity, Correlation and Variable Ranking"
output: html_notebook
---


```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

if(!require("tidyverse")){install.packages("tidyverse")}
if(!require("DALEX")){install.packages("DALEX")}
if(!require("randomForest")){install.packages("randomForest")}
if(!require("ggfortify")){install.packages("ggfortify")}
if(!require("survival")){install.packages("survival")}
if(!require("cowplot")){install.packages("cowplot")}
if(!require("pals")){install.packages("pals")}
if(!require("colorspace")){install.packages("colorspace")}
if(!require("ggsci")){install.packages("ggsci")}

# install https://indrajeetpatil.github.io/ggstatsplot/index.html
# remotes::install_github("IndrajeetPatil/ggstatsplot")
# sudo apt-get install libgmp3-dev
# sudo apt-get install libmpfr-dev
library("ggstatsplot")

```

# Load Data ---- 

```{r}

load("1.data.processed.rda")

sign <- c("age","ZIC2", "SEMA3G", "SAA1", "OTX1", "LINC01732", "LIMCH1", "IL4", "HHLA2", "GNB3", "FOXJ1", "DPP6", "AR", "AL353637.1")

sign <- intersect(sign, colnames(data))

data <- data[!is.na(data$metastasis), ]

data$gender <-ifelse(data$gender == 1, "Male", "Female")
```


# Aalen's additive regression model for censored data

The additive model provides an alternative to Cox regression. It can provide detailed information about temporal influence of each of the covariates not available in Cox's model.


```{r}
library(survival)
  
aa_fit <-aareg(as.formula(paste0("Surv(obs.time, status) ~ " , paste(sign, collapse= " + "))),
               data = data)
aa_fit

```


```{r}

vars <- c("Intercept", "age", "ZIC2", "SEMA3G", "SAA1", "OTX1", "LINC01732", "LIMCH1", "IL4", "HHLA2", "GNB3", "FOXJ1", "DPP6", "AR", "AL353637.1")
variables <- rev(factor(vars, levels=vars))

#-- color decrease of lightness
cols1 <- as.vector(glasbey(15))
cols1 <- readhex(file = textConnection(paste(cols1, collapse = "\n")),
                 class = "RGB")
#transform to hue/lightness/saturation colorspace
cols1 <- as(cols1, "HLS")
#additive decrease of lightness
cols1@coords[, "L"] <- pmax(0, cols1@coords[, "L"] + 0.05)
cols1 <- as(cols1, "RGB")
cols1 <- hex(cols1)


p1 <- ggcoefstats(
  x = aa_fit,
  title = "Aalen's additive regression model",
  subtitle = "(for censored data)",
  only.significant = F,
  #point.args = list(color = "green", shape = 9),
  package = "pals",
  stats.label.args = list(
    max.time = 3,
    direction = "y",
    point.padding = 0.2,
    nudge_x = .15,
    nudge_y = .5,
    segment.curvature = -0.1,
    segment.angle = 10,
    segment.size  = 0.2,
    segment.linetype = 2
    # nudge_x = .15,
    # box.padding = 0.5,
    # nudge_y = 1,
    # segment.curvature = -0.1,
    # segment.ncp = 3,
    # segment.angle = 20
    ),
  palette = "glasbey",
  sort = "none", 
  k = 3
) 

p2 <- ggplot2::autoplot(aa_fit) +
  theme(legend.position="none")

p2$layers[[1]]$data$variable <- factor(p2$layers[[1]]$data$variable,
                                       levels= variables)
p2$layers[[2]]$data$variable <- factor(p2$layers[[2]]$data$variable,
                                       levels= variables)
p2$data$variable <- factor(p2$data$variable,
                                       levels= variables)


p2 <- p2 +
  scale_fill_manual(values=rev(cols1))

pdf("fig_5_a_b_mRMR_aareg.pdf", width = 16, height = 9)
  cowplot::plot_grid(p1, p2, labels = "auto", nrow=1, rel_widths = c(0.7,1))
dev.off()

rm(list = setdiff(ls(),c("sign", "data")))
```


#  Collinearity Analysis with Variance Inflation Factor

```{r}
if(!require("tidyverse")){install.packages("tidyverse")}
if(!require("survival")){install.packages("survival")}
if(!require("glmnet")){install.packages("glmnet")}
if(!require("rms")){install.packages("rms")} # vif - One possible source for a `vif`-function
```


```{r}

setwd("~/gene_signature/plots")
load("1.data.processed.rda")

# Selecting the feature
sign <- c("AL353637.1", "AR",  "DPP6", "FOXJ1", "GNB3", "HHLA2", "IL4", "LIMCH1", "LINC01732", "OTX1", "SAA1", "SEMA3G", "ZIC2")
        
genes_vif <- setNames(data.frame(matrix(nrow=0, ncol=3)), c("sign", "gene", "vif"))

sign <- intersect(colnames(data), sign)

kirc_sign <- data[, c("obs.time", "status", sign) ]
  
surv_obj <- Surv(time = kirc_sign$obs.time, event = kirc_sign$status)

mdl1 <- coxph(as.formula(paste0("surv_obj ~ ", paste(sign, collapse= " + "))), data = kirc_sign)

  
cvif <- vif(mdl1) 
df_genes_vif <- as.data.frame(cvif)
df_genes_vif$gene  <- rownames(df_genes_vif)
rownames(df_genes_vif) <- NULL
genes_vif <- rbind(genes_vif, df_genes_vif)
print(cvif)
```


```{r}
pdf("fig_supl_2_vif.pdf", width = 12, height = 7)
ggplot(data=genes_vif, aes(x=gene, y=cvif)) +
  geom_bar(stat="identity", fill="steelblue") +
  geom_text(aes(label=round(cvif, digits = 2)), vjust = -0.6, hjust = - 0.3, angle = 45, size=4) +
  theme_minimal() +
   theme(plot.title=element_text(hjust=0.5, size=15), 
        axis.text.x = element_text(angle = 45, hjust=1, size=15),
        axis.text.y = element_text(angle = 0, hjust=1, size=13)) +
    ylim(0, 2.5) +
    xlab("Genes") +
    ylab("Variance Inflation Factors") +
    theme(axis.title.y = element_text(size = rel(1.8), angle = 90)) +
    theme(axis.title.x = element_text(size = rel(1.8), angle = 00))
dev.off()

rm(list = setdiff(ls(),c("sign", "data")))
  
```

#  Collinearity Analysis with Correlation

```{r}
if(!require("corrplot")){install.packages("corrplot")}
```


```{r}

sign <-  c("AL353637.1", "AR",  "DPP6", "FOXJ1", "GNB3", "HHLA2", "IL4", "LIMCH1", "LINC01732", "OTX1", "SAA1", "SEMA3G", "ZIC2")

kirc_sign <- data[, c(sign, "age", "status", "ajcc.stage") ]
kirc_sign$ajcc.stage <- as.numeric(sub("T","", kirc_sign$ajcc.stage))

dim(kirc_sign)

kirc_sign %>%
  select_if(is.numeric) %>%
  cor(.) %>%
  as.data.frame() %>%
  mutate(var1 = rownames(.)) %>%
  gather(var2, value, -var1) %>%
  filter(var1 != var2 )  %>%
  arrange(desc(value))
```


```{r}

kirc_cor <- cor(kirc_sign)

# mat : is a matrix of data
# ... : further arguments to pass to the native R cor.test function
cor.mtest <- function(mat, ...) {
    mat <- as.matrix(mat)
    n <- ncol(mat)
    p.mat<- matrix(NA, n, n)
    diag(p.mat) <- 0
    for (i in 1:(n - 1)) {
        for (j in (i + 1):n) {
            tmp <- cor.test(mat[, i], mat[, j], ...)
            p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
        }
    }
  colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
  p.mat
}

# matrix of the p-value of the correlation
p.mat <- cor.mtest(kirc_sign)
head(p.mat[, 1:5])

```

```{r}
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))

pdf("fig_supl_2_corrplot.pdf", width = 8, height = 8)
corrplot(kirc_cor, method="color", col=col(200),  
         type="lower", order="hclust", 
         addCoef.col = "black", # Add coefficient of correlation
         tl.col="black", tl.srt=45, #Text label color and rotation
         # Combine with significance
         tl.cex =0.8,
         p.mat = p.mat, sig.level = 0.01, insig = "blank", 
         # hide correlation coefficient on the principal diagonal
         diag=FALSE 
         )
dev.off()

rm(list = setdiff(ls(),c("sign", "data")))

```

# Variable Ranking and Feature Selection based on mutual information. 

```{r}
if(!require("varrank")){BiocManager::install("varrank")}

load("../data/1.data.processed.rda")
```

https://cran.r-project.org/web/packages/varrank/vignettes/varrank.html

Estimates the variables ranks based on mutual information. 

The filter approach based on mutual information is the Minimum Redundancy Maximum Relevance (mRMRe) algorithm.

For the first search, it is advised to use either ''peng'' (faster) or ''estevez'' (more reliable but much slower for large datasets) and, in case the number of variables is large (>100), restrict the ''forward'' search to ''n.var = 100.'' 

```{r}
sign <- c("AL353637.1", "AR",  "DPP6", "FOXJ1", "GNB3", "HHLA2", "IL4", "LIMCH1", "LINC01732", "OTX1", "SAA1", "SEMA3G", "ZIC2")

varrank_df <- data[, c("ajcc.stage", sign)]
#varrank_df <- data[, c("status", sign)]

varrank <- varrank(data.df = varrank_df, 
                   method = "estevez", # more reliable but much slower 
                   #method = "peng", # faster
                   variable.important = "ajcc.stage", 
                   #variable.important = "status", 
                   discretization.method = "sturges", 
                   n.var = 11,
                   algorithm = "forward", 
                   scheme="mid", 
                   verbose = T)

#summary(varrank)
pdf("../plots/fig_supl_3_varrank.pdf", width = 7, height = 6)
plot(x = varrank, colsep = F, rowsep = F,cellnote = F, labelscex =1)
dev.off()
```


